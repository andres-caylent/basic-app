--- 
steps: 
  - 
    args: 
      - build
      - "-t"
      - "gcr.io/andres-testing/nginx:latest"
      - "."
    name: gcr.io/cloud-builders/docker
  - 
    args: 
      - push
      - "gcr.io/andres-testing/nginx:latest"
    name: gcr.io/cloud-builders/docker

  -
    id: createvm
    name: gcr.io/cloud-builders/gke-deploy
    entrypoint: bash
    args:
      - "-c"
      - |    
          gcloud compute instances create private-instance \
          --boot-disk-auto-delete \
          --machine-type=n1-standard-1 \
          --metadata startup-script="sudo apt-get install tinyproxy && echo \"Allow localhost\" >> /etc/tinyproxy/tinyproxy.conf && sudo service tinyproxy restart" \
          --network=default \
          --preemptible \
          --tags tag-firewall \
          --zone=us-west1-a 
          --service-account=gke-custom@andres-testing.iam.gserviceaccount.com


  - 
    args: 
      - "-c"
      - |
          PROJECT_ID=$(gcloud config get-value project)
          gcloud container clusters get-credentials gke-e2e-demo --zone us-west1-a --project $PROJECT_ID
          echo y | gcloud compute ssh private-instance --project $PROJECT_ID --zone us-west1-a --  -L 8888:localhost:8888 -N -q -f
          export HTTPS_PROXY=localhost:8888
          kubectl get nodes
          kubectl apply -f resources.yaml
    entrypoint: bash
    id: deployment
    name: gcr.io/cloud-builders/gke-deploy
  - 
    args: 
      - "-c"
      - |
          PROJECT_ID=$(gcloud config get-value project)
          gcloud container clusters get-credentials gke-e2e-demo --zone us-west1-a --project $PROJECT_ID
          echo y | gcloud compute ssh private-instance --project $PROJECT_ID --zone us-west1-a --  -L 8888:localhost:8888 -N -q -f
          export HTTPS_PROXY=localhost:8888
          kubectl delete -f resources.yaml
    entrypoint: bash
    id: delete_deployment
    name: gcr.io/cloud-builders/gke-deploy


  -
    id: deletevm
    name: gcr.io/cloud-builders/gke-deploy
    entrypoint: bash
    args:
      - "-c"
      - |    
          gcloud compute instances delete private-instance --zone=us-west1-a